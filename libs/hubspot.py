from typing import Optional
import os
from datetime import datetime

import requests

BASE_URL = "https://api.hubapi.com/crm/v3"


class TooManyResultsError(Exception):
    def __init__(self, total: int):
        super().__init__(
            f"HubSpot limits to 10000 data, got {total}. Lower the timeframe"
        )


def get(
    session: requests.Session,
    start: datetime,
    end: datetime,
    after: Optional[str] = None,
) -> list[dict]:
    with session.post(
        f"{BASE_URL}/objects/deals/search",
        params={
            "hapikey": os.getenv("API_KEY"),
        },
        json={
            "limit": 100,
            "properties": [
                "hs_object_id",
                "dealname",
                "pipeline",
                "dealstage",
                "hubspot_owner_id",
                "dealtype",
                "project",
                "project_code",
                "property_code",
                "lot_number_new",
                "release_stage",
                "title_status",
                "house_type",
                "house_price",
                "land_price",
                "total_sale_price",
                "cash_or_finance",
                "st_soft_bc",
                "strategist_soft_bc___smsf",
                "membership_paid_date",
                "membership_paid_date",
                "onboarding_call_date",
                "strategy_session_date",
                "property_session_date",
                "strategy_session_date",
                "strategy_session_completed_date",
                "property_presentation_booked",
                "property_session_completed_date",
                "hard_bc_provided_date",
                "eoi_received_date",
                "eoi_deposit_paid",
                "contracts_issued",
                "contract_issued_by_docusign_admin_date",
                "solicitor_cos_review_date_zoom_in_person",
                "contract_signing_commitment_date",
                "contract_signed_date",
                "exchange_date",
                "original_deposit_due_date",
                "deposit_extension_request_made_to",
                "current_deposit_due_date",
                "deposit__committed_to__date",
                "deposit_paid",
                "build_balance_deposit_paid_date",
                "all_deposits_paid",
                "unconditional_date",
                "n1st_comms_issue_date",
                "n1st_comms_paid_date",
                "title_date",
                "settlement_type",
                "settlement_term",
                "original_developer_estimated_settlement_date",
                "estimated_land_settlement_date",
                "solicitor_settlement_due_date",
                "current_solicitor_settlement_due_date",
                "settlement_extension_made_to",
                "target_settlement",
                "actual_settlement_date",
                "balance_comms_issue_date",
                "balance_comms_paid_date",
                "build_approval_submitted_to_council_date",
                "estimated_build_approval_date",
                "build_approval_date",
                "transfer_to_site_date",
                "estimated_transfer_to_site_date",
                "site_cut_date",
                "lender_progress_payment_sla1",
                "rental_guarantee_provider1",
                "loan_associate___progress_payments",
                "progress_payment_status_update",
                "estimated_base_stage_completed_date",
                "slab_pour",
                "base_stage_invoice_sent_to_lender_date",
                "base_estimated_paid_date",
                "base_progress_paid",
                "estimated_frame_stage_completion_date",
                "frame_stage_completion_date",
                "frame_stage_invoice_sent_to_lender_date",
                "frame_estimated_paid_date",
                "frame_progress_paid",
                "estimated_enclosed_stage_completion_date",
                "enclose_stage_completion_date",
                "enclosed_stage_invoice_sent_to_lender_date",
                "enclose_progress_paid",
                "estimated_enclosed_stage_progress_paid_date",
                "estimated_fixing_stage_completion_date",
                "fixing_stage_completion_date",
                "fixing_stage_invoice_sent_to_lender_date",
                "estimated_fixing_stage_progress_paid_date",
                "fix_progress_paid",
                "estimated_practical_completion_date",
                "practical_completion",
                "practical_completion_stage_invoice_sent_to_lender_date",
                "estimated_practical_completion_progress_paid_date",
                "practical_completion_progress_paid_date",
                "handover",
                "contract_signed_delay_reason",
                "loan_id_refi",
                "n1_inv_risk_level",
                "deposit_behind_reason",
                "n1_inv_notes",
                "deposit_notes_developer",
                "balance_deposit_extension",
                "deposit_commitment_date__1_reason",
                "balance_deposit_extension_2",
                "balance_deposit_extension__2_reason",
                "balance_deposit_extension_3",
                "balance_deposit_extension__3_reason",
                "deposit_commitment_date__4",
                "deposit_commitment_date__4_reason",
                "loan_id_property_purchase",
                "n2_inv_risk_level",
                "settlement_behind_reason",
                "n2_inv_notes__cloned_",
                "settlement_notes_developer",
                "settlement_commitment_date__1",
                "deposit_commitment_date__5_reason",
                "settlement_commitment_date__2",
                "settlement_extension__2_reason",
                "settlement_commitment_date__3",
                "settlement_extension__3_reason",
                "settlement_commitment_date__4",
                "settlement_commitment_date__4_reason",
                "settlement_penalties_from_date",
                "settlement_penalties",
                "settlement_penalties____other_",
                "settlement_penalties__other_",
                "purchaser_name",
                "strategist",
                "member_care_manager",
                "mortgage_planner",
                "mortgage_planner_deposit",
                "old_mortgage_broker",
                "loan_associate",
                "lender",
                "developer",
                "builder",
                "smsf_agency",
                "buyer_solicitors",
                "rental_guarantee_provider",
                "is_replacement_deal",
                "dor_cost",
                "dor_payee",
                "dor_paid",
                "dor_replacement_deal_id",
                "member_care_gdrive_link",
                "land_size___sqm__",
                "build_size",
                "house_configuration",
                "bed",
                "bath",
                "garage",
                "house_features",
                "form_6_returned_date",
                "form_6_sent_date",
                "rental_guarantee_value",
                "rg_email_sent_date",
                "rent_received_per_week",
                "tenancy_start_date",
                "rental_period",
                "landlord_insurance_provider",
                "landlord_insurance_policy_effective_date",
                "contact_id_1",
                "contact_id_2",
                "contact_id_3",
                "contact_id_4",
                "member_category",
                "ss_outcome",
                "entry_ts__p__final_psi_inspection",
                "entry_ts__p__1_part_settlement",
                "entry_ts__p__base_stage",
                "entry_ts__p__build_pack_sent_to_owner",
                "entry_ts__p__organise_insurance_and_certificate_of_occ",
                "entry_ts__p__defects_inspection___dep_schedule",
                "entry_ts__p__enclosed_stage",
                "entry_ts__p__fixing_stage",
                "entry_ts__p__frame_stage",
                "entry_ts__p__intro_to_pm",
                "entry_ts__p__2_part_settlement",
                "entry_ts__p__site_cut_confirmed",
                "entry_ts__p__waiting_on_build_pack_from_builder",
                "entry_ts__p__waiting_on_settlement_letter",
                "entry_ts__p___so__dor___awaiting_new_sale_to_complete",
                "entry_ts__p___so__dor___documentation_issued",
                "entry_ts__p___so__dor___documentation_requested",
                "entry_ts__p___so__dor___replacement_buyer_required",
                "entry_ts__p___so__deal_terminated__no_dor",
                "entry_ts__p__deed_of_rescission__so_only_",
                "entry_ts__p___so__dor_completed___awaiting_refund",
                "entry_ts__p___so__nsw_all_deposits_paid__awaiting_exchange__sales_op_only_",
                "entry_ts__p___so__nsw_balance_deposit_paid__awaiting_exchange__sales_op_only_",
                "entry_ts__p___so__nsw_awaiting_smsf_deposit__sales_op_only_",
                "entry_ts__p___so__nsw_awaiting_cash_deposit__sales_op_only_",
                "entry_ts__p___so__nsw_awaiting_refinance_for_deposit__sales_op_only_",
                "entry_ts__p__strategy_session__completed_fa_form___sent_to_mp_",
                "entry_ts__p__2nd_prop_session_booked",
                "entry_ts__post_settlement_sales",
                "entry_ts__p__eoi_received",
                "entry_ts__p__all_eoi_documents_received__nm_",
                "entry_ts__p__approval_required",
                "entry_ts__p__approved",
                "entry_ts__p___so__awaiting_exchange__all_states_except_nsw___sales_op_only_",
                "entry_ts__p__awaiting_settlement___90_days",
                "entry_ts__p__awaiting_settlement",
                "entry_ts__p__booked_for_settlement",
                "entry_ts__p___so__cos_with_contract_team_for_issuance",
                "entry_ts__p__collect_the_bank_details",
                "entry_ts__p__contracts_unconditional",
                "entry_ts__p___so__contract_exchanged__balance_deposit_paid__awaiting_conditions__sales_op_only_",
                "entry_ts__p___so__contract_exchanged__awaiting_cash_deposit__sales_op_only_",
                "entry_ts__p___so__contract_exchanged__awaiting_refinance_for_deposit__sales_op_only_",
                "entry_ts__p___so__contract_exchanged__awaiting_smsf_deposit__sales_op_only_",
                "entry_ts__p__contract_review_completed__not_signed_",
                "entry_ts__p___so__contract_signed__awaiting_verification__sales_op_only_",
                "entry_ts__p__contract_signing_booked",
                "entry_ts__p___so__contract_under_internal_verification__sales_op_only_",
                "entry_ts__p___so__eoi_contract_requested__sales_op_only_",
                "entry_ts__p__eoi_deposit_refund_approved_by_team_leader__nm_",
                "entry_ts__p__eoi_not_compliant__repeat_sales_",
                "entry_ts__p__eoi_not_compliant__nm___cloned_",
                "entry_ts__p__finance_workshop_booked",
                "entry_ts__p__titles_confirmed___call_for_settlement",
                "entry_ts__p__membership_refunded",
                "entry_ts__p__refund_requested",
                "entry_ts__p__deal_not_proceeding__so_only_",
                "entry_ts__p__membership_and_or_eoi_deposit_refund_request__nm___cloned_",
                "entry_ts__p__new_property_deal_created__repeat_sales_",
                "entry_ts__p__new_property_deal_created",
                "entry_ts__p__one_off_prop_needed_acqs_team",
                "entry_ts__p__practical_completion",
                "entry_ts__p__settlement_pack_confirmed",
                "entry_ts__p__pre_ss__soft_bc__done",
                "entry_ts__p__prop_session_booked",
                "entry_ts__p__prop_session_completed",
                "entry_ts__p__loan_valuation_confirmed",
                "entry_ts__p__rescind_confirmation",
                "entry_ts__p__completed___closed",
                "entry_ts__p__refund_completed",
                "entry_ts__p__bank_account_received",
                "entry_ts__p__r__refund_requested_from_developer",
                "entry_ts__p__ready_0_3mths",
                "entry_ts__p__ready_12mths_",
                "entry_ts__p__ready_3_6mths",
                "entry_ts__p__ready_6_12mths",
                "entry_ts__p__rental_campaign_started",
                "entry_ts__p__requested_bank_details",
                "entry_ts__p__reschedule_ss",
                "entry_ts__p__ss_allocated",
                "entry_ts__p__start_loan_app",
                "entry_ts__p__conditional_finance_approved___subject_to_valuations",
                "entry_ts__p__settlement_loan_unconditional_approval",
                "entry_ts__p__start_settlement_process",
                "entry_ts__p__strategist_to_book_contract_signing",
                "entry_ts__p__team_leader_workshopping_eoi_deposit_refund_solution__nm_",
                "entry_ts__p__tenants_secured",
                "entry_ts__p__winback_successful",
                "entry_ts__p__winback_unsuccessful",
                "entry_ts__p__winback_contact_attempted",
                "entry_ts__p_smsf_entity_setup",
                "entry_ts__p_smsf_referred_to_advisors",
                "bare_trust",
                "contract_entity_name",
                "smsf_docs_signed_date",
                "abn_verification_date",
                "bank_account_setup_date",
                "rollover_authority_sent_for_signing",
                "rollover_commenced_date",
                "estimated_smsf_funds_accessible_date",
                "actual_smsf_funds_accessible_date",
                "is_under_ato_audit",
                "is_member_controlling_own_rollover",
                "cash_deposit_refunded",
                "smsf_trustee",
                "smsf_trustee_acn",
                "bare_trustee",
                "bare_trustee_acn",
                "firstname",
                "lastname",
                "freedom_status",
                "membership_rep",
                "mc",
                "specialist",
                "refund_request_date",
                "date_of_refund",
                "membership_refund_transfer_ownership",
                "onboarding_call_booking_date",
                "estimated_settlement_date__mp_",
                "mp_id",
                "id_property_deal_2",
                "id_property_deal_3",
                "id_property_deal_4",
                "update_current_deal",
                "create_new_deal",
                "la___post_approval",
                "aggregator",
                "lender_application_id",
                "lender_solicitor_name",
                "lender_solicitor_ref__no_",
                "loan_amount",
                "lvr",
                "settlement_deal_commencement_date",
                "all_docs_collected_date",
                "discharge_submitted_to_lender_date",
                "soca_sent_date",
                "loan_submitted_date",
                "loan_conditional_date",
                "val_received_date",
                "loan_unconditional_date",
                "loan_docs_issued_date",
                "loan_docs_returned_date",
                "loan_settlement_ready_date",
                "actual_settlement_date__mp_",
                "n1st_valuation_date",
                "n1st_valuation_firm",
                "n1st_valuation_price",
                "n2nd_valuation_date",
                "n2nd_valuation_firm",
                "n2nd_valuation_price",
                "n3rd_valuation_date",
                "n3rd_valuation_firm_cloned_",
                "n3rd_valuation_price",
                "n4th_valuation_date_cloned_",
                "n4th_valuation_firm",
                "n4th_valuation_price",
                "valuation_access_estimated_date",
                "valuation_access_contact_name",
                "valuation_contact_number",
                "loan_processor",
                "soca_completed_date",
                "entry_ts__l__3_month_check_in_for_re_val",
                "entry_ts__l__pl_approved",
                "entry_ts__l__pl_mir",
                "entry_ts__l__pl_signed___returned",
                "entry_ts__l__pl_funded",
                "entry_ts__l__pl_start_application",
                "entry_ts__l__r__conditional_approval_for_refi__for_every_buyer_type_",
                "entry_ts__l__pl_submitted",
                "entry_ts__l__r__deals_on_hold",
                "entry_ts__l__r__deposit_paid",
                "entry_ts__l__r__discovery_session_completed__30_mins_",
                "entry_ts__l__r__assessment",
                "entry_ts__l__r__loan_assessed___soca_presented",
                "entry_ts__l__r__refinance_application_submitted",
                "entry_ts__l__r__uc_loan_docs_issued",
                "entry_ts__l__r__docs_collected",
                "entry_ts__l__r__pre_loan_submission_compliance_check_completed",
                "entry_ts__l__r__ready_for_settlement",
                "entry_ts__l__r__soca___loan_app_signed",
                "entry_ts__l__r__member_signed_off_on_all_pre_loan_submission_docs",
                "entry_ts__l__r__refi_settled",
                "entry_ts__l__r__refi_settlement_booked",
                "entry_ts__l__r__uc_loan_approval_for_refi",
                "entry_ts__l__r__uc_loan_docs_signed_and_returned",
                "entry_ts__l__s__discovery_session_booked_with_mp__30_mins_",
                "entry_ts__l__s__discovery_session_completed__30_mins_",
                "entry_ts__l__s___do_not_use__mp_allocated",
                "entry_ts__l__s___do_not_use__provide_soft_bc_to_strategist",
                "entry_ts__l__s__reschedule_discovery_session_with_mp_",
                "entry_ts__l__s__12_month_check_in_for_re_val",
                "entry_ts__l__s__3_month_check_in_for_re_val",
                "entry_ts__l__s__6_month_check_in_for_re_val",
                "entry_ts__l__s__9_month_check_in_for_re_val",
                "entry_ts__l__s__build_pack_and_base_stage_invoice_paid",
                "entry_ts__l__s__base_stage_invoice_sent_to_lender",
                "entry_ts__l__s__base_stage_progress_paid",
                "entry_ts__l__s__deals_not_proceeded_with",
                "entry_ts__l__s__deals_awaiting_title___90_days",
                "entry_ts__l__s__deals_on_hold",
                "entry_ts__l__s__enclosed_stage_invoice_sent_to_lender",
                "entry_ts__l__s__enclosed_stage_progress_paid",
                "entry_ts__l__s__enclosed_stage_invoice_paid",
                "entry_ts__l__s__fixing_stage_invoice_paid",
                "entry_ts__l__s__frame_stage_invoice_paid",
                "entry_ts__l__s__final_payment_paid",
                "entry_ts__l__s__fixing_stage_invoice_sent_to_lender",
                "entry_ts__l__s__frame_stage_invoice_sent_to_lender",
                "entry_ts__l__s__final_lender_selection_and_recommendations",
                "entry_ts__l__s__loan_assessed___soca_presented",
                "entry_ts__l__s__conditional_app_submitted",
                "entry_ts__l__s__loan_docs_issued",
                "entry_ts__l__s__loan_docs_signed_and_returned",
                "entry_ts__l__s__mp_strategy_session_booked__1_hour_",
                "entry_ts__l__s__mp_strategy_session_completed__1_hour_",
                "entry_ts__l__s__member_docs_received",
                "entry_ts__l__s__ordered_vals",
                "entry_ts__l__s__members_contacted___settlement_deal_commenced",
                "entry_ts__l__s__purchase_deals_to_be_commenced",
                "entry_ts__l__s__post_settlement_follow_up_call",
                "entry_ts__l__s__practical_completion_progress_paid",
                "entry_ts__l__s__practical_invoice_sent_to_lender",
                "entry_ts__l__s__pre_loan_submission_compliance_check_completed",
                "entry_ts__l__s__progress_payment_authority_sent_to_member",
                "entry_ts__l__s__property_verification_with_strategist",
                "entry_ts__l__s__purchase_settled",
                "entry_ts__l__s__ready_for_settlement_pending_title",
                "entry_ts__l__s__purchase_settlement_booked",
                "entry_ts__l__s__soca___loan_app_signed",
                "entry_ts__l__s__loan_app_signed_and_received",
                "entry_ts__l__s__uc_approval",
                "entry_ts__l__s__intro_to_mortgage_planner_tl",
                "entry_ts__l__s__mortgage_planner_assigned",
                "entry_ts__l__d__loan_submitted_to_lender",
                "max_purchase_amount",
                "entry_ts__l__d__discovery_session_completed__30_mins_",
                "entry_ts__l__s__member_answered",
                "entry_ts__l__s__member_did_not_answer",
                "entry_ts__l__d__soca___loan_app_signed",
            ],
            "filterGroups": [
                {
                    "filters": [
                        {
                            "propertyName": "hs_lastmodifieddate",
                            "operator": "GTE",
                            "value": int(start.timestamp()) * 1000,
                        },
                        {
                            "propertyName": "hs_lastmodifieddate",
                            "operator": "LTE",
                            "value": int(end.timestamp()) * 1000,
                        },
                    ]
                },
            ],
            "after": after,
        },
    ) as r:
        res = r.json()
    if res["total"] > 10000:
        raise TooManyResultsError(res["total"])
    data = res["results"]
    if not data:
        return data
    _after = res.get("paging", {}).get("next", {}).get("after")
    return data + get(session, start, end, _after) if _after else data
